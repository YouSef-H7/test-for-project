name: Build & Deploy to AKS

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'k8s/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  # Azure Resources
  RESOURCE_GROUP: error-team-rg
  ACR_NAME: acrteam4
  AKS_CLUSTER_NAME: aks-cluster-team4
  AKS_NAMESPACE: app
  
  # Docker Images
  FRONTEND_IMAGE: acrteam4.azurecr.io/frontend
  BACKEND_IMAGE: acrteam4.azurecr.io/backend
  IMAGE_TAG: ${{ github.sha }}

jobs:
  #########################################################
  # STAGE 1: BUILD & PUSH - Docker Images to ACR
  #########################################################
  build_push:
    name: ğŸ³ Build & Push Docker Images
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ”‘ ACR Login
        run: |
          az acr login --name ${{ env.ACR_NAME }}

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:latest
            ${{ env.FRONTEND_IMAGE }}:${{ env.IMAGE_TAG }}
          cache-from: type=registry,ref=${{ env.FRONTEND_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.FRONTEND_IMAGE }}:buildcache,mode=max

      - name: ğŸ—ï¸ Build Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:latest
            ${{ env.BACKEND_IMAGE }}:${{ env.IMAGE_TAG }}
          cache-from: type=registry,ref=${{ env.BACKEND_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.BACKEND_IMAGE }}:buildcache,mode=max

      - name: âœ… Verify Images in ACR
        run: |
          echo "ğŸ“¦ Frontend images:"
          az acr repository show-tags --name ${{ env.ACR_NAME }} --repository frontend --output table
          echo ""
          echo "ğŸ“¦ Backend images:"
          az acr repository show-tags --name ${{ env.ACR_NAME }} --repository backend --output table

  #########################################################
  # STAGE 2: DEPLOY - Update AKS Deployments
  #########################################################
  deploy:
    name: ğŸš€ Deploy to AKS
    runs-on: ubuntu-latest
    needs: build_push
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: â˜¸ï¸ Get AKS Credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: ğŸ” Verify Cluster Connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: ğŸ“¦ Update Frontend Deployment
        run: |
          kubectl set image deployment/frontend-deployment \
            frontend=${{ env.FRONTEND_IMAGE }}:${{ env.IMAGE_TAG }} \
            -n ${{ env.AKS_NAMESPACE }}
          
          echo "âœ… Frontend image updated to ${{ env.IMAGE_TAG }}"

      - name: ğŸ“¦ Update Backend Deployment
        run: |
          kubectl set image deployment/backend-deployment \
            backend=${{ env.BACKEND_IMAGE }}:${{ env.IMAGE_TAG }} \
            -n ${{ env.AKS_NAMESPACE }}
          
          echo "âœ… Backend image updated to ${{ env.IMAGE_TAG }}"

      - name: â³ Wait for Frontend Rollout
        run: |
          kubectl rollout status deployment/frontend-deployment \
            -n ${{ env.AKS_NAMESPACE }} \
            --timeout=5m
          
          echo "âœ… Frontend deployment ready"

      - name: â³ Wait for Backend Rollout
        run: |
          kubectl rollout status deployment/backend-deployment \
            -n ${{ env.AKS_NAMESPACE }} \
            --timeout=5m
          
          echo "âœ… Backend deployment ready"

      - name: ğŸ” Verify Pods Status
        run: |
          echo "ğŸ“Š Pod Status:"
          kubectl get pods -n ${{ env.AKS_NAMESPACE }} -o wide
          echo ""
          echo "ğŸ“Š Deployment Status:"
          kubectl get deployments -n ${{ env.AKS_NAMESPACE }}

      - name: ğŸŒ Verify Ingress Status
        run: |
          echo "ğŸ“Š Ingress Configuration:"
          kubectl get ingress -n ${{ env.AKS_NAMESPACE }}
          echo ""
          echo "ğŸ“Š Services:"
          kubectl get services -n ${{ env.AKS_NAMESPACE }}

      - name: ğŸ¥ Health Check - Backend
        run: |
          echo "ğŸ” Checking backend health..."
          BACKEND_POD=$(kubectl get pod -n ${{ env.AKS_NAMESPACE }} -l app=backend -o jsonpath='{.items[0].metadata.name}')
          
          if [ -n "$BACKEND_POD" ]; then
            echo "ğŸ“ Using pod: $BACKEND_POD"
            kubectl exec -n ${{ env.AKS_NAMESPACE }} $BACKEND_POD -- curl -sf http://localhost:8080/actuator/health || echo "âš ï¸ Health check endpoint not ready yet"
          else
            echo "âš ï¸ No backend pod found"
          fi
        continue-on-error: true

      - name: ğŸ¥ Health Check - Frontend
        run: |
          echo "ğŸ” Checking frontend pods..."
          FRONTEND_POD=$(kubectl get pod -n ${{ env.AKS_NAMESPACE }} -l app=frontend -o jsonpath='{.items[0].metadata.name}')
          
          if [ -n "$FRONTEND_POD" ]; then
            echo "ğŸ“ Frontend pod: $FRONTEND_POD is running"
            kubectl describe pod $FRONTEND_POD -n ${{ env.AKS_NAMESPACE }} | grep -A 5 "Status:"
          else
            echo "âš ï¸ No frontend pod found"
          fi
        continue-on-error: true

      - name: ğŸ“ Deployment Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DEPLOYMENT COMPLETED SUCCESSFULLY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸŒ Application URL: http://135.220.213.50"
          echo ""
          echo "ğŸ“¦ Images Deployed:"
          echo "   Frontend: ${{ env.FRONTEND_IMAGE }}:${{ env.IMAGE_TAG }}"
          echo "   Backend:  ${{ env.BACKEND_IMAGE }}:${{ env.IMAGE_TAG }}"
          echo ""
          echo "â˜¸ï¸  Cluster: ${{ env.AKS_CLUSTER_NAME }}"
          echo "ğŸ“‚ Namespace: ${{ env.AKS_NAMESPACE }}"
          echo "ğŸ·ï¸  Image Tag: ${{ env.IMAGE_TAG }}"
          echo ""
          echo "ğŸ”— AGIC is managing ingress routing automatically"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  #########################################################
  # STAGE 3: POST-DEPLOYMENT VALIDATION
  #########################################################
  validate:
    name: âœ… Post-Deployment Validation
    runs-on: ubuntu-latest
    needs:
      - build_push
      - deploy
    
    steps:
      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: â˜¸ï¸ Get AKS Credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: ğŸ” Validate All Resources
        run: |
          echo "ğŸ” Validating deployment..."
          
          # Check if all pods are running
          NOT_RUNNING=$(kubectl get pods -n ${{ env.AKS_NAMESPACE }} --field-selector=status.phase!=Running --no-headers 2>/dev/null | wc -l)
          
          if [ "$NOT_RUNNING" -gt 0 ]; then
            echo "âš ï¸ Warning: Some pods are not in Running state"
            kubectl get pods -n ${{ env.AKS_NAMESPACE }}
          else
            echo "âœ… All pods are running"
          fi
          
          # Check ingress
          INGRESS_COUNT=$(kubectl get ingress -n ${{ env.AKS_NAMESPACE }} --no-headers 2>/dev/null | wc -l)
          echo "âœ… Found $INGRESS_COUNT ingress resource(s)"
          
          # Check services
          SERVICE_COUNT=$(kubectl get services -n ${{ env.AKS_NAMESPACE }} --no-headers 2>/dev/null | wc -l)
          echo "âœ… Found $SERVICE_COUNT service(s)"

      - name: ğŸ” Verify AGIC Configuration
        run: |
          echo "ğŸ” Checking AGIC annotations on ingress..."
          kubectl describe ingress -n ${{ env.AKS_NAMESPACE }} | grep -A 10 "Annotations:" || echo "No annotations found"
          echo ""
          echo "ğŸ” Checking ingress class..."
          kubectl get ingress -n ${{ env.AKS_NAMESPACE }} -o jsonpath='{.items[*].spec.ingressClassName}'
        continue-on-error: true

      - name: ğŸŒ Test Application Endpoint
        run: |
          echo "ğŸŒ Testing application accessibility..."
          
          # Wait a bit for AGIC to sync
          sleep 15
          
          # Test the public IP
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://135.220.213.50 || echo "000")
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 400 ]; then
            echo "âœ… Application is accessible (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ Application returned HTTP $HTTP_CODE (this may be normal if the app is still initializing)"
          fi
        continue-on-error: true

      - name: ğŸ“Š Final Status Report
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š FINAL VALIDATION REPORT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          kubectl get all -n ${{ env.AKS_NAMESPACE }}
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
